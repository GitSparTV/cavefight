AddCSLuaFile()

local P, G = {
  0x97, 0xA0, 0x89, 0x5B, 0x5A, 0x0F, 0x83, 0x0D, 0xC9, 0x5F, 0x60, 0x35, 0xC2, 0xE9, 0x07, 0xE1,
  0x8C, 0x24, 0x67, 0x1E, 0x45, 0x8E, 0x08, 0x63, 0x25, 0xF0, 0x15, 0x0A, 0x17, 0xBE, 0x06, 0x94,
  0xF7, 0x78, 0xEA, 0x4B, 0x00, 0x1A, 0xC5, 0x3E, 0x5E, 0xFC, 0xDB, 0xCB, 0x75, 0x23, 0x0B, 0x20,
  0x39, 0xB1, 0x21, 0x58, 0xED, 0x95, 0x38, 0x57, 0xAE, 0x14, 0x7D, 0x88, 0xAB, 0xA8, 0x44, 0xAF,
  0x4A, 0xA5, 0x47, 0x86, 0x8B, 0x30, 0x1B, 0xA6, 0x4D, 0x92, 0x9E, 0xE7, 0x53, 0x6F, 0xE5, 0x7A,
  0x3C, 0xD3, 0x85, 0xE6, 0xDC, 0x69, 0x5C, 0x29, 0x37, 0x2E, 0xF5, 0x28, 0xF4, 0x66, 0x8F, 0x36,
  0x41, 0x19, 0x3F, 0xA1, 0x01, 0xD8, 0x50, 0x49, 0xD1, 0x4C, 0x84, 0xBB, 0xD0, 0x59, 0x12, 0xA9,
  0xC8, 0xC4, 0x87, 0x82, 0x74, 0xBC, 0x9F, 0x56, 0xA4, 0x64, 0x6D, 0xC6, 0xAD, 0xBA, 0x03, 0x40,
  0x34, 0xD9, 0xE2, 0xFA, 0x7C, 0x7B, 0x05, 0xCA, 0x26, 0x93, 0x76, 0x7E, 0xFF, 0x52, 0x55, 0xD4,
  0xCF, 0xCE, 0x3B, 0xE3, 0x2F, 0x10, 0x3A, 0x11, 0xB6, 0xBD, 0x1C, 0x2A, 0xDF, 0xB7, 0xAA, 0xD5,
  0x77, 0xF8, 0x98, 0x02, 0x2C, 0x9A, 0xA3, 0x46, 0xDD, 0x99, 0x65, 0x9B, 0xA7, 0x2B, 0xAC, 0x09,
  0x81, 0x16, 0x27, 0xFD, 0x13, 0x62, 0x6C, 0x6E, 0x4F, 0x71, 0xE0, 0xE8, 0xB2, 0xB9, 0x70, 0x68,
  0xDA, 0xF6, 0x61, 0xE4, 0xFB, 0x22, 0xF2, 0xC1, 0xEE, 0xD2, 0x90, 0x0C, 0xBF, 0xB3, 0xA2, 0xF1,
  0x51, 0x33, 0x91, 0xEB, 0xF9, 0x0E, 0xEF, 0x6B, 0x31, 0xC0, 0xD6, 0x1F, 0xB5, 0xC7, 0x6A, 0x9D,
  0xB8, 0x54, 0xCC, 0xB0, 0x73, 0x79, 0x32, 0x2D, 0x7F, 0x04, 0x96, 0xFE, 0x8A, 0xEC, 0xCD, 0x5D,
  0xDE, 0x72, 0x43, 0x1D, 0x18, 0x48, 0xF3, 0x8D, 0x80, 0xC3, 0x4E, 0x42, 0xD7, 0x3D, 0x9C, 0xB4,
}, {
  {-0.99992770549409, 0.012024299785447}, {-0.38521692429645, -0.92282605145042}, {0.68275429674916, -0.73064804815352}, {0.9952084223755, 0.097776254954224},
  {-0.75928537778526, -0.65075780063054}, {0.56236786888229, 0.82688716282743}, {0.52337175868707, -0.85210445498706}, {-0.50358789816072, -0.86394399634818},
  {-0.1261563706716, 0.99201036795941}, {-0.58740727132745, -0.80929147875882}, {-0.7888602160397, 0.61457266417389}, {0.7059537136413, -0.70825797150196},
  {-0.78153938984123, -0.62385589852673}, {-0.98885750789689, 0.14886513720798}, {0.13519390451474, -0.99081916018114}, {-0.36104887430898, -0.93254689445637},
  {-0.8452324157679, 0.53439888036481}, {0.41218408235956, -0.91110058843654}, {0.73785868133881, -0.67495523286582}, {0.94779646638545, 0.31887592933185},
  {0.61533843699628, 0.78826303221385}, {0.17115336269177, -0.98524439934429}, {0.42207454792008, 0.90656112645428}, {0.96698998092786, -0.25481439673838},
  {-0.10985107412589, 0.99394805775422}, {0.75782674817613, 0.65245583739346}, {-0.24684023293166, 0.96905619001493}, {0.19336462381112, 0.98112696541191},
  {-0.90188228534515, -0.43198187853266}, {0.94757631488307, 0.319529540845}, {0.16885413676165, 0.98564105053436}, {0.98955883369462, 0.14412950654515},
  {0.4064155320474, 0.91368835787189}, {0.99851325686449, -0.054509410801024}, {0.76961002882366, 0.63851421560843}, {0.19247680600281, -0.98130152305546},
  {0.17908809841531, 0.98383304122498}, {0.5540085044092, 0.83251100715983}, {-0.25588971554618, -0.96670598088441}, {-0.16553781387498, 0.98620344360456},
  {-0.074904588689207, -0.99719070522809}, {-0.32211920510522, -0.9466991167749}, {0.96859896361176, -0.24862833243665}, {-0.9866192520999, 0.16304125669851},
  {0.84554395831683, -0.53390581056391}, {0.93130976627504, -0.36422811429204}, {-0.94771841050445, 0.31910784131843}, {0.29840011282514, 0.95444086913016},
  {0.26317264621134, 0.96474875396972}, {0.20866368944105, -0.97798745631467}, {-0.94367016575893, 0.33088762179403}, {-0.67832458920054, -0.73476237770175},
  {0.41748427110124, 0.90868414940675}, {-0.21409168837809, 0.97681356919702}, {0.68736786672767, 0.72630944905753}, {0.55629791530745, -0.83098292968303},
  {0.77077468274444, 0.63710783109314}, {-0.77308347688784, -0.63430429429652}, {-0.33707083535462, 0.94147928917918}, {-0.93914652948424, 0.34351680622308},
  {0.99534096581393, -0.096417642434349}, {0.56889452388373, 0.8224104940327}, {0.13194074948074, 0.99125760457434}, {-0.19049996447139, 0.98168720249191},
  {-0.76808815877349, -0.64034411089035}, {0.98708745007081, -0.16018228963498}, {0.9726403941827, 0.23231587032343}, {0.97375828260694, 0.22758472500233},
  {-0.7177721837727, -0.69627802794729}, {0.043594216864995, -0.99904932023195}, {-0.99577374375753, -0.091840357376834}, {0.55540831643848, -0.83157777870201},
  {0.3274438955977, 0.94487062354367}, {-0.18362153139413, 0.98299701586957}, {-0.7239992511463, 0.68980075698682}, {-0.97863244471156, -0.20561745586858},
  {-0.96029822443346, -0.27897548306249}, {-0.96537466968346, 0.26086729793813}, {0.78136982726418, 0.62406825992126}, {-0.49780928964247, 0.86728652194396},
  {0.81579567483249, -0.5783402259264}, {0.63481777789898, -0.77266188521461}, {0.19243751463049, 0.98130922902153}, {-0.53330609115058, 0.84592234462845},
  {-0.92883554285624, -0.3704922864608}, {0.11443304062253, -0.99343096348658}, {-0.11675411935974, -0.99316085082555}, {0.50813293491576, 0.86127865435868},
  {0.39791655104293, -0.9174216143116}, {0.87078151208126, 0.49167017218607}, {0.90761638516943, -0.41980054474949}, {0.20661887521728, 0.97842150446724},
  {-0.21354059197461, -0.97693419204117}, {-0.4693351108434, -0.88302013212022}, {0.6693366912478, 0.74295921405515}, {-0.88206205410682, 0.47113324304793},
  {-0.96950137414567, -0.24508587378644}, {-0.42107945714259, -0.9070237542493}, {0.99965376956329, 0.026312373475213}, {-0.83840791399752, -0.54504327327866},
  {-0.30142141567051, -0.95349102259811}, {-0.96360711892114, 0.26732250254048}, {-0.9118258074451, -0.41057727272353}, {-0.19377648471395, 0.98104570432366},
  {0.3364154370071, -0.94171367928013}, {0.25132443127583, -0.96790290331411}, {0.61121258281571, 0.79146647345782}, {0.56025666994196, -0.82831905917077},
  {-0.5502400769216, 0.83500650162098}, {-0.67038244648331, -0.74201575148177}, {0.4212068097113, 0.90696462083856}, {-0.69510320115226, 0.71890996637123},
  {0.8591691095397, -0.51169174432734}, {0.73361393523053, 0.67956647506744}, {-0.90390927186486, -0.42772424321838}, {0.69496990397615, -0.71903882549371},
  {0.2403986553347, -0.97067424325222}, {-0.86151114960729, -0.50773865236195}, {0.98007957439977, -0.19860520598508}, {-0.69275600159196, -0.72117204761299},
  {0.66307694470812, 0.74855124433571}, {-0.86299252810135, 0.50521668266323}, {-0.60847712618514, 0.79357141260852}, {-0.99356871866989, 0.11323074353137},
  {-0.78525438141338, -0.61917328468781}, {-0.70922462951768, -0.70498257062534}, {0.40257655575923, 0.91538632104322}, {0.254439392692, -0.96708872160031},
  {-0.68879875810022, 0.72495259902948}, {0.72128405112212, -0.69263938495935}, {0.040148861217656, 0.99919370941921}, {-0.38431420916657, 0.92320235519234},
  {0.37209255232445, -0.92819563266839}, {-0.064949938579667, 0.9978885235729}, {-0.99597547809456, -0.089626151508941}, {0.97518396580742, -0.22139609940582},
  {0.85611176262538, 0.51679072156383}, {-0.14642216281909, 0.98922219457278}, {0.56240766115078, 0.82686009861337}, {-0.062838319757845, -0.99802371994357},
  {-0.99889574819231, -0.046981743723695}, {-0.89708537133122, 0.44185725810892}, {0.29914401794928, -0.95420797341311}, {-0.17223668568819, -0.98505559442254},
  {-0.48169969434003, 0.87633635350402}, {0.98937264669898, 0.14540208376726}, {0.14044353327809, 0.9900886899467}, {-0.99983426528211, 0.018205547719699},
  {0.79420999876822, 0.60764338049269}, {-0.57946937107801, 0.81499401714519}, {0.33463978005323, 0.9423461240998}, {-0.99820339897305, -0.05991639407253},
  {0.14201376093497, -0.98986468353261}, {0.71380905064798, -0.70034037382764}, {-0.65952181612098, -0.75168542227482}, {0.81875915318444, -0.57413713438229},
  {0.80736886617953, 0.59004704382276}, {0.96052489684787, -0.27819403756262}, {-0.92015877422474, -0.39154543825363}, {-0.97100999133259, 0.2390389021316},
  {0.55958232995725, -0.82877476795545}, {-0.81565336887155, -0.57854090767075}, {-0.60707969784172, -0.79464095066162}, {-0.81854620125683, -0.57444069877405},
  {-0.99856984155851, -0.053462805106036}, {-0.92907774014981, 0.36988451273083}, {-0.89208894429538, 0.45185984051026}, {0.97688762031532, 0.2137535433032},
  {0.95978294984663, -0.28074310175623}, {-0.61178156372376, 0.79102674941351}, {0.97744656725676, -0.21118287846786}, {0.91716710994223, 0.39850281359134},
  {0.7177279582966, -0.69632361577028}, {-0.99241971496001, -0.12289470842429}, {0.98204441690405, -0.18864984290368}, {-0.68562779455183, -0.72795228369585},
  {-0.9250989948731, -0.37972601923596}, {0.83450485817892, -0.55100058228262}, {-0.33357367542493, -0.94272403335414}, {-0.9289878450272, -0.3701102319468},
  {0.56741373766457, 0.82343284505145}, {0.96798197749047, -0.25101970291918}, {0.9888475887883, -0.14893101136957}, {0.48479382909433, -0.87462846013153},
  {-0.51847805877236, 0.85509093234091}, {0.18752110366691, -0.98226057422638}, {-0.97964921426364, -0.20071725633996}, {-0.47780884209793, -0.87846383557494},
  {-0.59704020469354, -0.80221131504081}, {0.76494882422057, 0.64409106213607}, {-0.98469522033789, 0.1742851773494}, {-0.65476150939425, 0.755835541514},
  {0.32820552927271, 0.94460633628767}, {0.082219613765243, 0.99661423585673}, {0.028950924124678, -0.99958083414616}, {-0.97767727728342, -0.21011221164816},
  {0.42451794835031, -0.90541952239194}, {-0.99154205993735, -0.12978575952392}, {-0.65059384461198, -0.75942586824061}, {0.33883046695544, -0.94084744494671},
  {-0.96278743699705, -0.27025978457895}, {-0.77252511203909, 0.6349842134014}, {-0.61264444558722, 0.79035864219424}, {-0.36352621634831, -0.9315839683182},
  {0.20645970287568, 0.97845510427842}, {-0.33941956830995, -0.94063508155304}, {-0.70129229258192, 0.71287384603813}, {0.86325695259209, -0.5047647311386},
  {-0.99986084766597, 0.016681885525823}, {-0.082516820698895, -0.99658967198228}, {0.99189769046584, -0.12703925239282}, {-0.82252179376675, 0.56873359209627},
  {-0.99429873882923, -0.10663028632899}, {-0.99953996436582, -0.030329187849018}, {-0.8633920404947, 0.50453363060395}, {0.99756612109651, -0.0697268530801},
  {-0.16924048024252, 0.98557478653184}, {0.90679944206302, 0.42156229892413}, {-0.98460892644778, 0.17477202853816}, {-0.99575097417092, -0.092086901553203},
  {-0.81775203017953, -0.57557068821932}, {-0.58385646201102, -0.81185690350453}, {-0.99909273442508, 0.042587651015432}, {0.99767320267557, -0.0681775671542},
  {-0.60614444381085, 0.7953545833383}, {-0.69980576449577, -0.71433317995071}, {-0.99282406842193, -0.11958415096545}, {0.8350493262187, 0.55017508375215},
  {0.37732024333945, 0.92608284400817}, {0.61241845727648, 0.79053376473563}, {0.9936009412924, -0.1129476403598}, {-0.66321337725136, 0.7484303683275},
  {-0.10876370562513, -0.99406763167236}, {0.30134582168799, -0.95351491637582}, {0.73778449029236, 0.67503632930683}, {-0.12414792159412, 0.99226372178159},
  {0.83301813613863, 0.55324568219202}, {0.62510865288967, 0.78053774545659}, {0.99844272800451, 0.055786368361028}, {0.82708561450561, 0.56207596130583},
  {0.46887755694242, 0.88326317516112}, {0.99151312858407, -0.130006599238}, {0.3260387337027, 0.94535641116224}, {0.24718127408743, -0.96896925531232},
  {-0.98780233472125, -0.15571302938176}, {-0.95885324498686, -0.28390219192211}, {-0.84896155058316, 0.52845462021959}, {-0.9848676743048, -0.17330800359316},
  {-0.97451747561433, 0.22431159069978}, {-0.23205037070345, 0.97270377066011}, {-0.3627355005779, 0.93189213786817}, {0.59297476008919, -0.80522104660594},
  {-0.28562253319295, -0.9583421980339}, {0.085579006216526, 0.99633138748862}, {-0.83518681340051, 0.54996635053601}, {0.37393859953046, -0.92745346178727},
}

for i = 1, 256 do
  P[256 + i] = P[i]
  G[256 + i] = G[i]
end

local function sCurve(t)
    return t * t * (3. - 2. * t)
end

local map256 = function(x)
    return bit.band(x - 1, 255) + 1
end

function perlinNoise(x, y)

    local ix = math.floor(x)
    local iy = math.floor(y)

    local bx0 = map256(ix)
    local bx1 = map256(ix + 1)
    local by0 = map256(iy)
    local by1 = map256(iy + 1)

    local dx0 = x - ix
    local dx1 = dx0 - 1
    local dy0 = y - iy
    local dy1 = dy0 - 1

    local i = P[bx0]
    local j = P[bx1]
    local b00 = P[i + by0] + 1
    local b10 = P[j + by0] + 1
    local b01 = P[i + by1] + 1
    local b11 = P[j + by1] + 1

    local g00 = G[b00]
    local g10 = G[b10]
    local g01 = G[b01]
    local g11 = G[b11]

    local dot00 = dx0 * g00[1] + dy0 * g00[2]
    local dot10 = dx1 * g10[1] + dy0 * g10[2]
    local dot01 = dx0 * g01[1] + dy1 * g01[2]
    local dot11 = dx1 * g11[1] + dy1 * g11[2]

    local sx = sCurve(dx0)
    local sy = sCurve(dy0)

    local a = Lerp(sx, dot00, dot10)
    local b = Lerp(sx, dot01, dot11)
    local noise = Lerp(sy, a, b)

    return noise
end
